# 컨셉

이 저장소는 다른 프로젝트에서 사용할 공용 패키지입니다.

## 목표

타 프로젝트에서 subtree로 사용한다.

타 프로젝트에서 본 프로젝트로 PR을 할 수 있다.

본 프로젝트 독자적으로 로컬 개발 환경 가동 및 테스트가 가능하다

## 🔧 브랜치 운영 전략 - 공유용 브랜치(main) / 테스트용 브랜치(dev) 분리 전략

독자적인 테스트를 하면서도, 타 프로젝트에서 실질적으로 사용할 패키지만 받기 위해서는 본 프로젝트에서 테스트 코드와 패키지 코드를 분리해서 관리해야 합니다.

이 저장소는 아래와 같이 **브랜치 분리 전략**을 사용합니다.

### 브랜치 역할

1. **`main` 브랜치**

   - 다른 프로젝트에서 subtree 방식(`git subtree`)으로 공유할 파일만 포함합니다.
   - 예: `src/`, `index.ts`, `tsconfig.json` 등
   - 테스트 코드, 문서, 스토리북, 설정 파일 등은 포함하지 않습니다.

2. **`dev` 브랜치**
   - 독자적인 개발 및 테스트 작업을 수행할 수 있는 브랜치입니다.
   - main 브랜치에서 관리하는 공유용 패키지 외에 테스트 코드(`test/`), 스토리북(`.storybook/`), 문서 등을 포함합니다

### 브랜치 운영 전략

실무에서는 다음같이 사용합니다.

1. 본 프로젝트를 독자적으로 로컬에서 가동 및 테스트, 개발하는 건 dev 브랜치를 사용합니다.

2. 타 프로젝트에서 공유 패키지를 사용할 때에는 본 프로젝트의 main 브랜치를 기준으로 패키지를 가져옵니다.

3. PR은 자신이 바라보는 브랜치를 기준으로 합니다.

dev 브랜치에서의 변경 사항은 동일하게 dev로 반영하고, 타 프로젝트에서 공유 패키지를 수정하면 본 프로젝트의 main 브랜치에 PR합니다.

4. 둘 간에 동기화 작업을 수행하고 git 이력으로 남깁니다.

두 브랜치 각자에 들어온 커밋은 주기적으로 동기화하여 충돌을 방지합니다.

# 사용 시작하기

## 타 프로젝트에서 사용하는 경우

타 프로젝트에서 공유 패키지를 subtree로 받아오고, 수정하며 본 프로젝트의 원격 레포지토리에 반영하는 방법은 다음과 같습니다.

### 1. 공유 패키지의 원격 저장소를 remote로 추가 (한 번만)

먼저, 공유 패키지 저장소를 원하는 이름으로 등록합니다.

예시로 저는 `shared-origin`으로 등록해보겠습니다.

```bash
git remote add shared-origin https://github.com/charchar111/subtree-test2.git
```

### 2. 공유 패키지 저장소의 main 브랜치를 subtree로 가져오기

#### 2-a. 최초에 가져오는 경우

공유 패키지 저장소의 main 브랜치를 subtree로 등록합니다.

등록을 위해서는 가져올 파일의 위치를 설정해야 합니다.

아래 커맨드를 봐주세요

```bash
git subtree add --prefix=shared shared-origin main --squash
```

##### subtree 명령어 옵션 설명

- `--prefix` 로 가져올 위치를 설정합니다.

- `shared-origin`은 원격 레포지토리, `main`은 해당 레포지토리에서 가져올 브랜치입니다

- `--squash`는 가져올 브랜치의 커밋을 압축해서 가져오는 옵션입니다. 레포지토리의 git 변경 내역이 공유 패키지와 섞이지 않도록 해줍니다.

#### 2-b. 이미 등록한 subtree에 원격 레포지토리의 변경사항을 갱신하는 경우

만약 이미 공유 패키지를 subtree로 등록한 상황이고 최신 변경 사항을 갱신하는 경우라면 아래처럼 최신화 가능합니다.

```bash
git subtree pull --prefix=shared shared-origin main --squash
```

자세한 옵션은 위의 [subtree 명령어 옵션 설명](#subtree-명령어-옵션-설명)을 참고하세요

**여기까지 완료되었다면 공유 패키지를 사용할 수 있습니다. 아래는 공유 패키지를 수정하고 원래 원격 저장소에 PR하는 방법입니다.**

---

### 3. A 프로젝트 내에서 shared 코드 수정 및 커밋

만약 공유 패키지 코드를 직접 수정하고 변경사항을 다른 사람에게 공유하고자 한다면
아래처럼 subtree가 있는 위치의 변경사항을 수동으로 추가하고 커밋을 만들어주세요

```bash
# shared는 subtree가 추가된 위치이며, 알맞게 바꿔주세요
git add shared/
git commit -m "fix: 공유 패키지 수정"
```

### 4. 수정 사항을 shared 저장소의 main 브랜치로 푸시

간단한 방식과, 리뷰 및 이력 관리에 유리한 방식이 있습니다.

#### 기본 방식

변경사항을 subtree 레포에 push할 때 자동으로 처리하는 방식입니다.

간단하지만, PR의 커밋이 squash 될 수 있습니다.

즉, 100개의 커밋이 하나로 압축되면서 제대로 리뷰를 하기 어려울 수 있습니다.

또한, 이력이 병합되면서 개별 변경 사항을 파악할 수 없습니다

간단하지만, 엄격한 PR 리뷰와 개별 변경 사항 확인에는 적합하지 않습니다.

```bash
git subtree push --prefix=shared <원격 서브 레포> <브랜치명>
# 원 레포의 트리에서 shared 내 변경사항만 서브 트리 레포의 브랜치에 반영함
```

#### 리뷰 및 이력 관리에 유리한 방식: split 사용하기

프로젝트 내 전체 변경사항 중 공유 패키지의 변경사항만을 따로 추출하여 별도의 브랜치를 만들고 공유 패키지의 저장소로 PR하는 방식입니다.

PR의 커밋을 살리기 좋습니다.

즉, 100개의 커밋을 전부 분리하여 살려 보낼 수 있습니다.

"어떤 파일이 어떻게 바뀌었는지", "누가 커밋했는지", "리뷰 승인" 이 가능합니다.

```bash
# 서브트리 디렉토리의 변경사항만 정제하여 split-subtree 브랜치로 추가
git subtree split --prefix=shared -b split-subtree

# git push  <원격 서브트리레포> <스플릿 브랜치>:<원격 서브트리 레포의 브랜치>
git push  subtree1 split-subtree:main

# 사용 후 해당 브랜치는 삭제
```

## 독자적으로 공유 프로젝트 개발을 하는 경우

중요한 건, dev 브랜치와 그 서브 트리 브랜치인 main 브랜치 간에 동기화 입니다.

### dev => main으로 동기화

dev 브랜치에서 서브트리가 추가된 폴더(eg : ./src)의 변경사항을 main으로 반영하려면 다음 명령을 씁니다.

```bash
git subtree push --prefix=src . main
```

### main => dev으로 동기화

git subtree pull --prefix=src . main

# 고급

## 메타 파일 관리

이론상 main은 실질적 공유 패키지, dev는 그 외의 모든 테스트 및 로컬 개발용 파일이라 구분했습니다만,
main에도 공유를 위한 최소한의 meta 파일이 포함됩니다.

메타 파일 종류는 아래와 같습니다.

### 중요도: 필수

#### gitignore

main 브랜치를 커밋할 때 불필요한 파일을 제외하는 목적입니다.

main과 dev를 git checkout으로 오고 갈때 git은 두 브랜치 간에 차이를 비교하여 파일을 수정 및 추가, 삭제합니다.
하지만, untrack file로 설정된 것들은 이런 수정 작업이 이뤄지지 않는데, 대표적으로 node_modules는 main으로 checkout을 하여도 그대로 남아있습니다.

만약, gitignore이 없다면 이런 파일들이 그대로 원격 저장소에 올라가버리니, 이를 방지하기 위해 main에 별도의 gitignore이 필요합니다.

- git은 프로젝트 내 모든 gitignore을 통합하여 제외할 파일을 선별합니다. gitignore은 기본적으로 자기 위치의 하위에 모든 디렉토리에 적용되다가, 다른 gitignore을 만나면
  해당 설정을 국소적으로 적용하는 방식입니다. (예컨대, ./src/asset/.gitignore은 ./,gitignore과 별개로 .src/asset/ 내에서만 작동합니다)

#### package.json

#### tsconfig.json

#### README.md

#### index.ts

배럴 익스포트 전용 파일입니다.

### 중요도: 선택
